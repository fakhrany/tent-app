{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "pnpm install && pnpm build"
  },
  "deploy": {
    "startCommand": "pnpm start",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  },
  "services": [
    {
      "name": "tent-app",
      "serviceName": "web",
      "variables": {
        "NODE_ENV": "production",
        "PORT": "3000"
      },
      "healthcheckPath": "/",
      "healthcheckTimeout": 30
    },
    {
      "name": "postgres",
      "serviceName": "database",
      "image": "pgvector/pgvector:pg16",
      "variables": {
        "POSTGRES_DB": "tent",
        "POSTGRES_USER": "tent",
        "POSTGRES_PASSWORD": "${RANDOM_PASSWORD}"
      },
      "volumes": [
        {
          "mountPath": "/var/lib/postgresql/data",
          "name": "pgdata"
        }
      ]
    }
  ],
  "environments": {
    "production": {
      "variables": {
        "DATABASE_URL": "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${RAILWAY_PRIVATE_DOMAIN}:5432/${POSTGRES_DB}",
        "NEXTAUTH_URL": "https://${RAILWAY_PUBLIC_DOMAIN}",
        "NEXT_PUBLIC_APP_URL": "https://${RAILWAY_PUBLIC_DOMAIN}"
      }
    }
  }
}
